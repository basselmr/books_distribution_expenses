{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <style>
        
    </style>
</head>
<body>
    {% csrf_token %}
    {% include 'sidenav.html' %}
    <div class="main-content">
        <h1>Categories</h1>
            <div style="display: block;margin: 3px;margin-bottom: 10px;">
                <input id="categorySearch" type="text">
                <button onclick="search()">Search</button>
            </div>
            <div style="margin: 10px 0;border: solid 1px rgb(134, 112, 233);padding: 20px;border-radius: 7px;">
                {% for category in categoryList %}
                <div id="category{{category.id}}" style="display: block;margin: 3px;">
                    <label style="display: none;">{{category.id}}</label>
                    <input id="cat_{{category.id}}_name" type="text" value="{{category.category}}" >
                    <button>Update</button>
                    <button onclick="getParentId(this)">Delete</button>
                </div>
            {% endfor %}
            </div>
            <div id="category_new" style="display: block;margin: 3px;">
                    <input type="text" id="newCategoryName" value="{{category.category}}" name="category" >
                    <button onclick="addNewCategory()">ADD</button>
                    <p id="newCatErr" style="margin: 0;color: red;font-size: 12px;"></p>
            </div>
    </div>
    <script>
        function getParentId(button) {
        // Get the parent element ID when the button is clicked
        var inputValue = button.parentElement.querySelector('input[type="text"]').value;
        var confirmation = confirm("Are you sure you want to delete this category '" + inputValue + "' ?");
        var parentID = button.parentElement.id;
        
        alert("Parent element ID:"+ parentID);
        alert (inputValue)
        }
        
        window.onload = function() {
            var urlParams = new URLSearchParams(window.location.search);
            var searchValue = urlParams.get('category');
            if (searchValue) {
                document.getElementById("categorySearch").value = decodeURIComponent(searchValue);
            }
        }
        
        function search() {
            var searchValue = document.getElementById("categorySearch").value
            console.log(searchValue)

            if (searchValue){
                console.log(searchValue)
            }
           
            if (searchValue){
                window.location.href = "/categories" + "?" + "category=" + encodeURIComponent(searchValue);
                
            } else {
                window.location.href = "/categories"
            }           
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function addNewCategory () {
            const inputText = document.getElementById("newCategoryName").value;
            console.log(inputText);
            if (!inputText.trim()) {
                console.log("New category title is required.");
                document.getElementById("newCatErr").innerHTML="New category title is required."
                return
            } else {
                const regex = /^[a-zA-Z0-9\s]+$/;
                if (!regex.test(inputText)) {
                    document.getElementById("newCatErr").innerHTML="Only numeric, alphabetic characters accepted."
                    console.log("Only numeric, alphabetic characters accepted.");
                    return
                } else {
                    const csrftoken = getCookie('csrftoken');
                    console.log(csrftoken)
                    const form = new FormData();
                    form.append("category", inputText);
                    console.log(form);
                    const options = {
                        method: 'POST',
                        headers: {
                            'cookie': 'csrftoken='+csrftoken,
                            'X-CSRFToken': csrftoken,
                        }
                    };
                    options.body = form;
                    fetch('/categories', options)
                    .then(response => response.text())
                    .then(response => console.log(response))
                    .catch(err => console.error(err));

                }
            }
        }
    
    </script>
</body>
</html>